#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Detect system language
LANGUAGE=$(echo $LANG | cut -d'_' -f1)

# Allow change language with an arg (eg: --lang=es)
for arg in "$@"; do
    if [[ $arg == --lang=* ]]; then
        LANGUAGE="${arg#*=}"
    fi
done

# Curiosities in different languages
declare -A CURIOSITIES_ES CURIOSITIES_EN

# File route based on language
PHRASES_FILE="$SCRIPT_DIR/phrases-en.txt"
[[ "$LANGUAGE" == "es" ]] && PHRASES_FILE="$SCRIPT_DIR/phrases-es.txt"

# Read phrases from file
IFS=$'\n' read -d '' -r -a CURIOSITIES < "$PHRASES_FILE"

NUM_CURIOSITIES=${#CURIOSITIES[@]}
LAST_INDEX=${LAIN_LAST_INDEX:-"-1"}

# Random choice!
RANDOM_INDEX=$((RANDOM % NUM_CURIOSITIES))
while [ "$RANDOM_INDEX" -eq "$LAST_INDEX" ]; do
    RANDOM_INDEX=$((RANDOM % NUM_CURIOSITIES))
done

export LAIN_LAST_INDEX=$RANDOM_INDEX
RANDOM_MESSAGE="${CURIOSITIES[$RANDOM_INDEX]}"


# Get the last index from the global variable
LAST_INDEX=${LAIN_LAST_INDEX:-"-1"}  # If it doesn't exists assign -1
NUM_CURIOSITIES=${#CURIOSITIES[@]}  # Total amount of curiosities


# Generate a new random index different to the last one
RANDOM_INDEX=$((RANDOM % NUM_CURIOSITIES))
while [ "$RANDOM_INDEX" -eq "$LAST_INDEX" ]; do
    RANDOM_INDEX=$((RANDOM % NUM_CURIOSITIES))
done

# Save the last index in the variable
export LAIN_LAST_INDEX=$RANDOM_INDEX  

RANDOM_MESSAGE="${CURIOSITIES[$RANDOM_INDEX]}"

# Generate message
message="$*"
if [ -z "$message" ]; then
    message="$RANDOM_MESSAGE"
fi

# Avoid negative lenght
length=$(( ${#message} + 2 ))
if (( length < 2 )); then
    length=2
fi

# Max text width | 80 characters
MAX_WIDTH=80
formatted_message=$(echo "$message" | fold -s -w $MAX_WIDTH)

# Determine the longest line to set the border width
lenght=$(echo "$formatted_message" | awk '{print length}' | sort -nr | head -n 1) # Detects the longest line to generate the correct borders

# Generate edges with exact lenght
top_edge=" $(head -c $lenght < /dev/zero | tr '\0' '_')"
lower_edge=" $(head -c $lenght < /dev/zero | tr '\0' '-')"

# Format text with spaces and aligned borders
text=$(echo "$formatted_message" | while IFS= read -r line; do
    padding=$(( lenght - ${#line} ))
    printf "| %s%*s |\n" "$line" "$padding" ""
done)


lain="
                          @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@    
                        #@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@   
                       %@@@@@@@@@@@@@@@@@%@%%@@@@@@@@@@@@@@@@@@@@@@@@@@%  
                      #@@@@@@@@%%%%%@%@%@%%@%%%@@%@@%@@@@@@@@@@@@@@@@@@%* 
                      @@@%@%%%%%%%@@%@%%@%%%@@@---%%@@@%%@@@@@@@@@@@@@@@@ 
                     @@@@%%%%%%%%@@%%%%%%%%%%%----%@%%@%%@%%@@@@@@@@@@@@% 
                     @@%%%%%@%%%%@%%%%%%%%%%+%----%%%%%%%%%%@@%@@%@@@@@@%%
                    %@@%%%%%%%%%@%%%%%%%%+%+=*----%#%@%%%%%%%@%@%%%%%%@%%%
                    @@%%%%%%%%%%%%%%%%%%@#*==-----+%%@%%%%%%%@%%%%%%%%%%%%
                    @@%%%%%%%%%+%%%@*++%#@@@@----%=%+%%%%%%%%+%%%%%%%%%%%%
                    @@%%%%%%%%@*%@===-===#======-=-++%%%%%%%%+%@%%%%%%%%%%
                   %@@%%%%%%@%=%+==@#=####@+===----=====#=*%%+%%%%%%%%%%%%
                   @@@%%@%%+@+=+=-::--#%##%=-:::-:-:::::===@+#+%%%%%%%%%% 
                   @@@%@+%@==----::::-+-----::::::::::::-=#==@@@+%%%%%%=% 
                  % @@++=%#==-:::::::::::::::::::::::::-=##@*===%%%%%%%   
                    @@@+==+=-::::::::::::::::::::::::::--####@+==*%%@%    
                    @@@@=====-::::::::::::::::::::::::::-*%#*-@=+@% @#    
                    =@@@@@@@=-::::::::::::::::::::-#:::::::----+=%@ #     
                    %@@@@@@@%=-:::::::::::::::::==#-:::::::---=@%#        
                    @@@@@@@@===-:::::::::::----:::::::::::::--@@%%        
                    @@@@@@@@====--::::::::::--#%-::::::::-:--@@%%%        
                   @ @@@@@@@=====-::::::::::::::::::::::-:-- @@%%%        
                    %@  @ @@=======-::::-::::::::::::-----%@ @@%%%        
                           ==========--:-:::::::::------@@@  @@%%@        
                           ==========*==------------*@@@@@%  @@%%#        
                          ==============*==-==+%@@@%@@=@ *   @@%%         
                         ====================#      *        @@%%         
                   @%% ++====================-              #@@%%         
                 +============+==============               #@@%*         
              =+=====*=============%+========    +#         %@@%          
           *--===========++===================::::-=        %@%%          
       =-----=----=============+%@========-::::-::::===     @@@%          
    +-------------=--::::==============:::::::::::::-==-::- @@%           
  =-----------------:::::::::-======::::::::::::::::-==::::-@@@           
 ====--------------------:::::::::::::::::::::::::::-=-::---%%--+         


"

# Show message and image
echo -e "$top_edge\n$text\n$lower_edge\n$lain"
